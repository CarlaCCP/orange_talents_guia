package br.com.orange.forum.config.validacao;

import java.util.ArrayList;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.MessageSource;
import org.springframework.context.i18n.LocaleContextHolder;
import org.springframework.http.HttpStatus;
import org.springframework.validation.FieldError;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.ResponseStatus;
import org.springframework.web.bind.annotation.RestControllerAdvice;

// Essa classe tratará a saída de erros de validacao
@RestControllerAdvice
public class ErroValidacaoHadler {
	
	@Autowired
	private MessageSource messageSource; // Para passar a mensagem na lingua falada
	
	@ResponseStatus(code =HttpStatus.BAD_REQUEST) // ainda queremos que o erro seja 400, só iremos mudar a mensagem
	@ExceptionHandler(MethodArgumentNotValidException.class) // esse é o nome do erro 
	public List <ErroFormularioDTO> handler (MethodArgumentNotValidException exception) {
		List<ErroFormularioDTO> dto = new ArrayList<>();// chama a classe como lista
		List<FieldError> fieldError = exception.getBindingResult().getFieldErrors(); //pegará a lista de erros
		
		fieldError.forEach(e ->{ // irá fazer a iteração do campo do erro e a mensagem
			String mensagem = messageSource.getMessage(e, LocaleContextHolder.getLocale());
			ErroFormularioDTO erro = new ErroFormularioDTO(e.getField(),mensagem);
			dto.add(erro);
		});
		
		return dto;
	}

}
